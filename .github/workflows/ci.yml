name: CI - Comprehensive Test Suite

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]
  workflow_dispatch:  # Allows manual triggering

jobs:
  # Job 1: Quick validation tests (syntax, structure)
  quick-tests:
    name: Quick Validation Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify required files exist
        run: |
          echo "Checking for required files..."
          test -f run_snid.sh || (echo "run_snid.sh not found" && exit 1)
          test -f snid_dockerfile || (echo "snid_dockerfile not found" && exit 1)
          test -f Makefile || (echo "Makefile not found" && exit 1)
          echo "✓ All required files present"

      - name: Check script syntax
        run: |
          echo "Validating bash script syntax..."
          bash -n run_snid.sh
          bash -n tests/*.sh
          echo "✓ All scripts have valid syntax"

      - name: Make test scripts executable
        run: chmod +x tests/*.sh

      - name: Run run_snid.sh unit tests
        run: ./tests/test_run_snid.sh

  # Job 2: Docker build tests
  docker-build-tests:
    name: Docker Build Tests
    runs-on: ubuntu-latest
    needs: quick-tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Check for required tarballs
        id: check-tarballs
        run: |
          if [ -f snid-5.0.tar.gz ] && [ -f templates-2.0.tgz ]; then
            echo "tarballs_present=true" >> $GITHUB_OUTPUT
            echo "✓ Required tarballs found"
          else
            echo "tarballs_present=false" >> $GITHUB_OUTPUT
            echo "⚠ Required tarballs not found (snid-5.0.tar.gz, templates-2.0.tgz)"
            echo "⚠ These must be downloaded from: https://people.lam.fr/blondin.stephane/software/snid/"
            echo "⚠ Skipping Docker build tests"
          fi

      - name: Download SNID tarball (if not present)
        if: steps.check-tarballs.outputs.tarballs_present == 'false'
        run: |
          echo "Attempting to download SNID and templates..."
          # Note: These URLs may not work if the files require manual download
          # In that case, they should be stored in the repository or as GitHub secrets
          echo "⚠ Files must be manually provided or stored as release assets"

      - name: Make test scripts executable
        run: chmod +x tests/*.sh

      - name: Run Docker build tests
        if: steps.check-tarballs.outputs.tarballs_present == 'true'
        run: ./tests/test_docker_build.sh

      - name: Skip Docker build tests
        if: steps.check-tarballs.outputs.tarballs_present == 'false'
        run: |
          echo "⚠ Skipping Docker build tests due to missing tarballs"
          echo "To run these tests, add snid-5.0.tar.gz and templates-2.0.tgz to the repository"

  # Job 3: Integration tests
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: docker-build-tests
    if: always()  # Run even if docker-build-tests is skipped

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Check for required tarballs
        id: check-tarballs
        run: |
          if [ -f snid-5.0.tar.gz ] && [ -f templates-2.0.tgz ]; then
            echo "tarballs_present=true" >> $GITHUB_OUTPUT
          else
            echo "tarballs_present=false" >> $GITHUB_OUTPUT
          fi

      - name: Make test scripts executable
        run: chmod +x tests/*.sh

      - name: Run integration tests
        if: steps.check-tarballs.outputs.tarballs_present == 'true'
        run: ./tests/test_integration.sh

      - name: Skip integration tests
        if: steps.check-tarballs.outputs.tarballs_present == 'false'
        run: |
          echo "⚠ Skipping integration tests due to missing tarballs"
          echo "To run these tests, add snid-5.0.tar.gz and templates-2.0.tgz to the repository"

  # Job 4: Multi-platform build verification
  multi-platform-build:
    name: Multi-Platform Build Test
    runs-on: ${{ matrix.os }}
    needs: quick-tests
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Docker availability
        run: |
          if command -v docker &> /dev/null; then
            echo "✓ Docker is available"
            docker --version || echo "Docker command found but daemon may not be running"
          else
            echo "⚠ Docker is not available on this platform"
            echo "This is expected for macOS runners in GitHub Actions"
          fi

      - name: Check script compatibility
        run: |
          echo "Testing script on ${{ matrix.os }}..."
          bash -n run_snid.sh
          echo "✓ Script is compatible with ${{ matrix.os }}"

      - name: Verify OS detection logic
        run: |
          echo "Current OS: $(uname)"
          if [[ "$(uname)" == "Darwin" ]]; then
            echo "✓ Running on macOS"
          elif [[ "$(uname)" == "Linux" ]]; then
            echo "✓ Running on Linux"
          else
            echo "⚠ Unknown OS: $(uname)"
          fi

  # Job 5: Generate test report
  test-report:
    name: Generate Test Report
    runs-on: ubuntu-latest
    needs: [quick-tests, docker-build-tests, integration-tests, multi-platform-build]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate test summary
        run: |
          echo "# SNID-Docker CI Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Quick Tests | ${{ needs.quick-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Build Tests | ${{ needs.docker-build-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | ${{ needs.integration-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Multi-Platform Build | ${{ needs.multi-platform-build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Notes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Docker build and integration tests require snid-5.0.tar.gz and templates-2.0.tgz" >> $GITHUB_STEP_SUMMARY
          echo "- Download from: https://people.lam.fr/blondin.stephane/software/snid/" >> $GITHUB_STEP_SUMMARY

      - name: Check overall status
        run: |
          if [[ "${{ needs.quick-tests.result }}" == "success" ]]; then
            echo "✓ CI tests completed"
            echo "Note: Some tests may have been skipped if tarballs are not present"
          else
            echo "✗ CI tests failed"
            exit 1
          fi
